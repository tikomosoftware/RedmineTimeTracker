# Redmine Time Tracker - アプリケーション仕様書

**バージョン**: 1.0  
**最終更新日**: 2026年2月13日  
**対象フレームワーク**: .NET 9.0  
**UIフレームワーク**: WPF (Windows Presentation Foundation)

---

## 目次

1. [概要](#概要)
2. [システム要件](#システム要件)
3. [機能仕様](#機能仕様)
4. [画面仕様](#画面仕様)
5. [データモデル](#データモデル)
6. [API連携仕様](#api連携仕様)
7. [ローカルデータ保存](#ローカルデータ保存)
8. [多言語対応](#多言語対応)
9. [エラーハンドリング](#エラーハンドリング)
10. [セキュリティ](#セキュリティ)

---

## 概要

### アプリケーション名
**Redmine Support Tool** (Redmine 月次作業時間登録ツール)

### 目的
Redmineへの作業時間入力を効率化・自動化するデスクトップアプリケーション。
定例タスクのテンプレート化と一括登録により、毎日の繰り返し作業を削減する。

### 主要機能
- 月次カレンダービューによる作業時間の可視化
- 作業テンプレートの管理（作成・編集・削除）
- テンプレートに基づく月全体への一括登録
- 休日・出勤日の柔軟な管理
- Redmine API通信ログの表示
- 日本語・英語の多言語対応

---

## システム要件

### 動作環境
- **OS**: Windows 10 以降
- **ランタイム**: 
  - Standalone版: 不要（.NET 9.0 Runtime同梱）
  - Framework-dependent版: .NET 9.0 Runtime が必要

### 外部依存
- **Redmine**: バージョン 3.0 以降（REST API対応）
- **ネットワーク**: RedmineサーバーへのHTTP/HTTPS接続

---

## 機能仕様

### 1. 接続設定機能

#### 1.1 初回起動時の設定
- アプリケーション初回起動時、自動的に設定ダイアログを表示
- Redmine URL と API Key の入力を促す

#### 1.2 設定項目
| 項目 | 必須 | 形式 | 説明 |
|------|------|------|------|
| Redmine URL | ✓ | URL | RedmineサーバーのベースURL（例: `https://redmine.example.com`） |
| API Key | ✓ | 文字列 | ユーザーのRedmine API Key |

#### 1.3 接続テスト
- 設定画面から接続テストを実行可能
- `/users/current.json` エンドポイントにアクセスして認証を確認
- 成功時: 「接続に成功しました！」メッセージを表示
- 失敗時: エラー内容を表示

#### 1.4 設定の保存場所
- `%LOCALAPPDATA%\RedmineSupTool\settings.json`
- **注意**: API Keyは平文で保存される（ユーザーに警告表示）

---

### 2. 作業テンプレート管理機能

#### 2.1 テンプレートの構成要素
| 項目 | 必須 | 説明 |
|------|------|------|
| 名前 | ✓ | テンプレートの識別名（例: "朝会"） |
| チケットID | ✓ | Redmineのチケット番号 |
| 時間(h) | ✓ | 作業時間（0.5刻み、最大8.0時間） |
| 作業分類 | ✓ | Redmineの作業分類（Activity） |
| 頻度 | ✓ | 適用頻度（毎日/毎週/月次） |
| 有効/無効 | - | テンプレートの有効状態（チェックボックス） |

#### 2.2 頻度の種類

##### 毎日（月～金）
- 月曜日から金曜日の平日に自動適用
- 土日は除外（ただし、出勤日設定されている場合も除外）

##### 毎週
- 指定した曜日に適用
- 複数曜日の選択可能（例: 月・水・金）
- 対象曜日: 月、火、水、木、金、土、日

##### 月次
- 月に1回、指定日に適用
- 選択肢:
  - 1日～31日（特定日）
  - 月末（その月の最終日）

#### 2.3 テンプレート操作
- **追加**: 「+ 追加」ボタンからテンプレート作成ダイアログを表示
- **編集**: 各テンプレートの「編集」ボタンをクリック
- **削除**: 各テンプレートの「削除」ボタンをクリック（確認ダイアログあり）
- **有効/無効切り替え**: チェックボックスで切り替え

#### 2.4 テンプレートの保存
- `%LOCALAPPDATA%\RedmineSupTool\templates.json`
- JSON形式で保存

---

### 3. カレンダー表示機能

#### 3.1 表示形式
- 月次カレンダー形式（週の開始: 月曜日）
- 曜日ヘッダー: 月、火、水、木、金、土、日
- 土曜日: 青色、日曜日: 赤色で表示

#### 3.2 日付セルの表示内容
各日付セルには以下の情報を表示:

1. **日付番号** (左上)
2. **ステータスアイコンとテキスト**:
   - ✓ X.Xh: 作業時間が登録済み（緑色）
   - 🚫 休日: 除外日として設定（オレンジ色）
   - 🏢 出勤日: 土日を出勤日として設定（青色）
   - - 未登録: 平日で未登録（グレー）

#### 3.3 日付セルの背景色
| 状態 | 背景色 | 枠線色 |
|------|--------|--------|
| 除外日 | #FFF3E0（薄いオレンジ） | #FF9800（オレンジ） |
| 出勤日（土日） | #E3F2FD（薄い青） | CornflowerBlue |
| 登録済み | #E8F5E9（薄い緑） | #E0E0E0（グレー） |
| 土日（通常） | #F0F0F0（グレー） | #E0E0E0（グレー） |
| 平日（未登録） | White | #E0E0E0（グレー） |

#### 3.4 右クリックメニュー
各日付セルを右クリックすると、コンテキストメニューを表示:

**平日の場合**:
- 休日に設定する（登録スキップ）
- 除外を解除する（除外日の場合のみ）

**土日の場合**:
- 出勤日に設定する
- 出勤日設定を解除する（出勤日の場合のみ）

---

### 4. 一括登録機能

#### 4.1 登録対象日の判定
以下の条件を満たす日のみ登録対象:
- 平日（月～金）、または出勤日設定された土日
- 除外日として設定されていない日

#### 4.2 登録処理フロー
1. 有効なテンプレートを取得
2. 対象月の各日について:
   - 登録対象日かチェック
   - 各テンプレートの頻度設定に基づき適用判定
   - 既存の時間エントリーがあれば更新（PUT）
   - なければ新規作成（POST）
3. 結果をサマリー表示:
   - 新規登録件数
   - 上書き件数
   - スキップ日数
   - エラー件数

#### 4.3 既存エントリーの扱い
- 同じ日・同じチケットIDのエントリーが存在する場合、上書き更新
- 同じ日に複数のテンプレートが適用される場合、それぞれ別エントリーとして登録
- 同じチケットIDのエントリーが複数ある場合、最初の1件のみ更新（残りは新規作成）

---

### 5. 休日・出勤日管理機能

#### 5.1 除外日（休日）設定
- 平日を休日として設定可能
- 設定された日は一括登録の対象外
- カレンダー上でオレンジ色の枠線と背景色で表示

#### 5.2 出勤日設定
- 土日を出勤日として設定可能
- 設定された日は一括登録の対象に含まれる
- カレンダー上で青色の枠線と背景色で表示

#### 5.3 保存場所
- 除外日: `%LOCALAPPDATA%\RedmineSupTool\excluded_dates.json`
- 出勤日: `%LOCALAPPDATA%\RedmineSupTool\work_days.json`
- 日付のリストをJSON形式で保存

---

### 6. 通信ログ機能

#### 6.1 ログ表示
- メニュー「表示」→「通信ログを表示」で表示/非表示切り替え
- 右側パネルに表示
- GridSplitterでパネル幅を調整可能

#### 6.2 ログ内容
以下の情報をタイムスタンプ付きで記録:
- APIリクエスト（メソッド、エンドポイント、パラメータ）
- データ読込開始/完了
- テンプレート読込件数
- 作業分類取得件数
- 既存時間エントリー取得件数
- エラー情報

#### 6.3 ログフォーマット
```
[HH:mm:ss] メッセージ内容
```

例:
```
[09:32:45] --- データ読込開始 ---
[09:32:45] テンプレート読込: 6件
[09:32:45] GET /enumerations/time_entry_activities.json
[09:32:46] 作業分類取得: 5件
```

#### 6.4 ログのクリア
- 「クリア」ボタンでログをクリア可能

---

### 7. プレビュー機能

#### 7.1 機能概要
一括登録を実行する前に、どの日にどのテンプレートが適用されるかをプレビュー表示

#### 7.2 表示内容
```
== 2026年2月 登録プレビュー ==

2/3 (月)
  朝会 (#1234) 0.5h
  設計作業 (#5678) 4.0h

2/4 (火)
  朝会 (#1234) 0.5h
  設計作業 (#5678) 4.0h

...

合計: 45件, 180.0h
```

---

## 画面仕様

### メイン画面

#### レイアウト構成
```
┌─────────────────────────────────────────────────┐
│ メニューバー                                      │
├─────────────────────────────────────────────────┤
│ 対象月: [2026年2月▼] [↻ 最新情報取得]  ステータス  │
├─────────────────────────────────────────────────┤
│ 作業テンプレート                    [+ 追加]       │
│ ┌───────────────────────────────────────────┐ │
│ │ 名前 │チケットID│時間│作業分類│頻度│操作  │ │
│ │ 朝会 │   1234   │0.5 │設計作業│毎日│編集削除│ │
│ └───────────────────────────────────────────┘ │
├─────────────────────────────────────────────────┤
│ 2026年2月                          合計: 0.0h    │
│ ┌───────────────────────────────────────────┐ │
│ │ 月 │ 火 │ 水 │ 木 │ 金 │ 土 │ 日 │        │ │
│ │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │        │ │
│ │✓4.5h│✓4.5h│✓4.5h│✓4.5h│✓4.5h│    │    │        │ │
│ └───────────────────────────────────────────┘ │
│                                                   │
│      [月全体に一括登録]  [プレビュー表示]         │
└─────────────────────────────────────────────────┘
```

#### メニューバー
- **設定**
  - 接続設定...
- **表示**
  - ☑ 通信ログを表示

#### ステータスバー
- 通常時: グレー色、通常フォント
  - 例: "準備完了 (6テンプレート, 45件登録済み)"
- エラー時: **赤色、太字**
  - 例: "エラー: 対象のコンピューターによって拒否されたため、接続できませんでした。"

---

### 設定ダイアログ

#### 画面構成
```
┌─────────────────────────────┐
│ 設定                         │
├─────────────────────────────┤
│ Redmine URL:                │
│ [https://redmine.example.com]│
│                             │
│ API Key:                    │
│ [****************************]│
│ ※ API Keyはローカルに平文で  │
│    保存されます              │
│                             │
│         [接続テスト]         │
│                             │
│      [保存]  [キャンセル]    │
└─────────────────────────────┘
```

#### バリデーション
- Redmine URL: 空欄不可
- API Key: 空欄不可

---

### テンプレートダイアログ

#### 画面構成（追加時）
```
┌─────────────────────────────┐
│ テンプレート追加             │
├─────────────────────────────┤
│ 名前:                       │
│ [朝会                     ] │
│                             │
│ チケットID:                 │
│ [1234                    ] │
│                             │
│ 時間(h):                    │
│ [0.5 ▼]                     │
│                             │
│ 作業分類:                   │
│ [設計作業 ▼]                │
│                             │
│ 頻度:                       │
│ ○ 毎日 (月～金)             │
│ ○ 毎週                      │
│   ☑月 ☑火 ☑水 ☑木 ☑金 □土 □日│
│ ○ 月次                      │
│   [1 ▼] 日 / 月末           │
│                             │
│      [保存]  [キャンセル]    │
└─────────────────────────────┘
```

#### バリデーション
- 名前: 空欄不可
- チケットID: 数値のみ、空欄不可
- 時間: 選択必須
- 作業分類: 選択必須
- 頻度: 選択必須
  - 毎週の場合: 最低1つの曜日を選択
  - 月次の場合: 日付を選択

#### チケットID重複チェック
- 既存のテンプレートと同じチケットIDを入力した場合、警告を表示
- 警告内容: 「チケットID #XXXX は既に以下のテンプレートで使用されています: [テンプレート名]。入力ミスではありませんか？そのまま保存しますか？」
- ユーザーが「はい」を選択した場合のみ保存

---

## データモデル

### WorkTemplate（作業テンプレート）

```csharp
public class WorkTemplate
{
    public int Id { get; set; }                    // 一意のID
    public string Name { get; set; }               // テンプレート名
    public int IssueId { get; set; }               // チケットID
    public decimal DefaultHours { get; set; }      // デフォルト時間
    public int ActivityId { get; set; }            // 作業分類ID
    public string ActivityName { get; set; }       // 作業分類名
    public FrequencyType Frequency { get; set; }   // 頻度タイプ
    public List<DayOfWeek> TargetDays { get; set; } // 対象曜日（毎週の場合）
    public int MonthlyDay { get; set; }            // 対象日（月次の場合、0=月末）
    public bool IsEnabled { get; set; }            // 有効/無効
    public string FrequencyDisplay { get; set; }   // 頻度の表示用文字列
}

public enum FrequencyType
{
    Daily,   // 毎日（月～金）
    Weekly,  // 毎週
    Monthly  // 月次
}
```

### RedmineSettings（Redmine接続設定）

```csharp
public class RedmineSettings
{
    public string BaseUrl { get; set; }      // Redmine URL
    public string ApiKey { get; set; }       // API Key
    public bool IsConfigured { get; set; }   // 設定済みフラグ
}
```

### Activity（作業分類）

```csharp
public class Activity
{
    public int Id { get; set; }       // 作業分類ID
    public string Name { get; set; }  // 作業分類名
}
```

### TimeEntry（時間エントリー）

```csharp
public class TimeEntry
{
    public int Id { get; set; }           // エントリーID
    public string SpentOn { get; set; }   // 作業日（yyyy-MM-dd形式）
    public decimal Hours { get; set; }    // 作業時間
    public Issue Issue { get; set; }      // チケット情報
}

public class Issue
{
    public int Id { get; set; }  // チケットID
}
```

---

## API連携仕様

### 使用するRedmine REST API

#### 1. ユーザー情報取得（接続テスト用）
```
GET /users/current.json
```
**用途**: 接続テストおよび認証確認

**レスポンス例**:
```json
{
  "user": {
    "id": 1,
    "login": "admin",
    "firstname": "Redmine",
    "lastname": "Admin"
  }
}
```

---

#### 2. 作業分類一覧取得
```
GET /enumerations/time_entry_activities.json
```
**用途**: テンプレート作成時の作業分類選択肢を取得

**レスポンス例**:
```json
{
  "time_entry_activities": [
    { "id": 9, "name": "設計作業" },
    { "id": 10, "name": "開発" },
    { "id": 11, "name": "テスト" }
  ]
}
```

---

#### 3. 時間エントリー一覧取得
```
GET /time_entries.json?spent_on=>=YYYY-MM-DD&spent_on<=YYYY-MM-DD
```
**用途**: 指定月の既存時間エントリーを取得

**パラメータ**:
- `spent_on`: 作業日の範囲指定

**レスポンス例**:
```json
{
  "time_entries": [
    {
      "id": 1,
      "issue": { "id": 1234 },
      "hours": 4.5,
      "spent_on": "2026-02-03",
      "activity": { "id": 9, "name": "設計作業" }
    }
  ]
}
```

---

#### 4. 時間エントリー作成
```
POST /time_entries.json
```
**用途**: 新規時間エントリーを作成

**リクエストボディ**:
```json
{
  "time_entry": {
    "issue_id": 1234,
    "hours": 4.5,
    "activity_id": 9,
    "spent_on": "2026-02-03"
  }
}
```

---

#### 5. 時間エントリー更新
```
PUT /time_entries/{id}.json
```
**用途**: 既存の時間エントリーを更新

**リクエストボディ**:
```json
{
  "time_entry": {
    "hours": 5.0,
    "activity_id": 9
  }
}
```

---

### 認証方式
すべてのAPIリクエストに以下のヘッダーを付与:
```
X-Redmine-API-Key: {API_KEY}
```

---

## ローカルデータ保存

### 保存場所
```
%LOCALAPPDATA%\RedmineSupTool\
```
実際のパス例:
```
C:\Users\{UserName}\AppData\Local\RedmineSupTool\
```

### 保存ファイル一覧

| ファイル名 | 内容 | 形式 |
|-----------|------|------|
| `settings.json` | Redmine接続設定 | JSON |
| `templates.json` | 作業テンプレート一覧 | JSON |
| `excluded_dates.json` | 除外日（休日）一覧 | JSON |
| `work_days.json` | 出勤日一覧 | JSON |

### データ形式例

#### settings.json
```json
{
  "BaseUrl": "https://redmine.example.com",
  "ApiKey": "a1b2c3d4e5f6...",
  "IsConfigured": true
}
```

#### templates.json
```json
[
  {
    "Id": 1,
    "Name": "朝会",
    "IssueId": 1234,
    "DefaultHours": 0.5,
    "ActivityId": 9,
    "ActivityName": "設計作業",
    "Frequency": 0,
    "TargetDays": [],
    "MonthlyDay": 0,
    "IsEnabled": true
  }
]
```

#### excluded_dates.json
```json
[
  "2026-02-11T00:00:00",
  "2026-02-24T00:00:00"
]
```

#### work_days.json
```json
[
  "2026-02-08T00:00:00",
  "2026-02-15T00:00:00"
]
```

---

## 多言語対応

### サポート言語
- 日本語（ja-JP）
- 英語（en-US）

### 言語切り替え
- システムのカルチャ設定に基づき自動選択
- リソースファイル:
  - `Resources/Strings.ja-JP.xaml`
  - `Resources/Strings.en-US.xaml`

### リソースキーの例

| キー | 日本語 | 英語 |
|------|--------|------|
| `AppTitle` | Redmine 月次作業時間登録ツール | Redmine Monthly Work Time Tool |
| `BtnAddTemplate` | + 追加 | + Add |
| `StatusLoading` | 読込中... | Loading... |
| `TitleError` | エラー | Error |
| `DayMon` | 月 | Mon |

---

## エラーハンドリング

### エラー表示方式

#### 1. ステータスバー表示
- 軽微なエラーや状態変化
- **エラー時**: 赤色・太字で表示
- 例: "エラー: 対象のコンピューターによって拒否されたため、接続できませんでした。"

#### 2. メッセージボックス
- 重要なエラーやユーザーの確認が必要な場合
- エラーアイコン付きダイアログ
- 例: データ読込エラー、接続エラー

#### 3. 通信ログ
- すべてのエラーをタイムスタンプ付きで記録
- ユーザーが詳細を確認可能

### 主なエラーケース

#### 接続エラー
- **発生条件**: Redmineサーバーに接続できない
- **表示**: ステータスバー（赤色・太字）+ メッセージボックス
- **メッセージ**: "データ読込エラー: 対象のコンピューターによって拒否されたため、接続できませんでした。 (localhost:8080)"

#### 認証エラー
- **発生条件**: API Keyが無効
- **表示**: メッセージボックス
- **メッセージ**: "接続に失敗しました: 401 Unauthorized"

#### データ形式エラー
- **発生条件**: Redmineからの応答が不正
- **表示**: ログに記録
- **処理**: 空のデータとして扱い、処理を継続

#### ファイル保存エラー
- **発生条件**: ローカルファイルの保存に失敗
- **表示**: ログに記録
- **メッセージ**: "出社日設定の保存エラー: {エラー内容}"

---

## セキュリティ

### API Key の扱い

#### 保存方法
- **平文保存**: `settings.json` に平文で保存
- **警告表示**: 設定画面に「※ API Keyはローカルに平文で保存されます」と明記

#### セキュリティ上の注意
- API Keyは暗号化されていない
- ローカルファイルへのアクセス権限を持つユーザーは閲覧可能
- 共有PCでの使用には注意が必要

### 通信セキュリティ
- HTTPS接続を推奨（HTTPも対応）
- 証明書検証は標準の.NET HTTPクライアントに準拠

### データの扱い
- すべてのデータはローカルに保存
- 外部サーバー（Redmine以外）への送信なし
- ログには機密情報（API Key）は記録しない

---

## 技術仕様

### 開発環境
- **言語**: C# 13
- **フレームワーク**: .NET 9.0
- **UIフレームワーク**: WPF (Windows Presentation Foundation)
- **HTTPクライアント**: System.Net.Http.HttpClient
- **JSONシリアライザー**: System.Text.Json

### プロジェクト構成
```
redmineSupTool/
├── Models/              # データモデル
│   ├── CalendarDay.cs
│   ├── TimeEntryInfo.cs
│   └── WorkTemplate.cs
├── Services/            # ビジネスロジック
│   ├── RedmineService.cs
│   └── TemplateService.cs
├── Views/               # ダイアログ画面
│   ├── SettingsDialog.xaml
│   ├── SettingsDialog.xaml.cs
│   ├── TemplateDialog.xaml
│   └── TemplateDialog.xaml.cs
├── Resources/           # 多言語リソース
│   ├── Strings.ja-JP.xaml
│   └── Strings.en-US.xaml
├── Properties/          # アプリケーションプロパティ
│   ├── Resources.cs
│   └── Resources.resx
├── App.xaml             # アプリケーション定義
├── App.xaml.cs
├── MainWindow.xaml      # メイン画面
└── MainWindow.xaml.cs
```

### ビルド設定
- **ターゲットフレームワーク**: net9.0-windows
- **出力タイプ**: WinExe
- **Nullable**: enable
- **プラットフォーム**: x64

---

## 今後の拡張可能性

### 検討中の機能
1. **コメント機能**: 時間エントリーにコメントを追加
2. **複数プロジェクト対応**: プロジェクトごとのテンプレート管理
3. **統計機能**: 月次・週次の作業時間統計
4. **エクスポート機能**: CSV/Excel形式でのデータ出力
5. **API Key暗号化**: より安全なAPI Key保存方式
6. **カスタム休日設定**: 祝日カレンダーの自動取得
7. **通知機能**: 未登録日のリマインダー

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0 | 2026-02-13 | 初版リリース |

---

## ライセンス

© 2026 tikomo software

---

## サポート

問題が発生した場合は、以下の情報を確認してください:
1. 通信ログの内容
2. Redmineサーバーのバージョン
3. エラーメッセージの詳細

---

**ドキュメント終了**
